<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<?php

include("../fixa/bd.php");

$tempo = 0;

set_time_limit($tempo);
date_default_timezone_set("Brazil/East");

$data_cadastro=date("Y-m-d H:i:s");

$id_usuario= (int) $_GET['id'];

$sql_serv = "SELECT * FROM v_geral_usuario_info WHERE id_usuario = $id_usuario";

$acao_serv=mysql_query($sql_serv,$conecta);

while($user_data = mysql_fetch_array($acao_serv)){
  $cpf  = $user_data['cpf'];
};



if(empty($_POST['nome']) || empty($_POST['cpf']) || empty($_POST['perfil']))
{
  echo" <script> 
          alert('Por favor preencher todos os campos obrigatórios !');
          history.back();
        </script>
        "; 
        exit();   
}


//valida cpf
$query_valida_cpf = mysql_query("SELECT cpf FROM usuario WHERE cpf = '{$_POST['cpf']}'");

if($_POST['cpf'] != $cpf){
  if(mysql_affected_rows() > 0){
    echo" <script> 
            alert('CPF já cadastrado na base de dados !');
            history.back();
          </script>
          "; 
        exit();   
  }
}

//valida perfil
$checkperfil = mysql_query("SELECT id_perfil, cpf FROM usuario WHERE id_usuario = $id_usuario");

while($row_sup=mysql_fetch_array($checkperfil)){ 
    $id_perfil      = $row_sup['id_perfil'];
    $cpf_supervisor = $row_sup['cpf'];
}

//atualiza informações caso usuario deixe de ser supervisor
if($id_perfil == 3 && $_POST['perfil'] != 3){

  //usuario que respodiam a supervisor removido ficam o status de supervisor não informado
  $sql_atualiza_dados = "UPDATE usuario SET id_supervisor = 1  WHERE id_supervisor = '{$id_perfil}'";
  $executa_query= mysql_query($sql_atualiza_dados) or die (mysql_error());

  //deleta supervisor da tabela de supervisores
  $sql_atualiza_dados_sup = "DELETE supervisor WHERE id_supervisor = '{$id_perfil}'";
  $executa_query_sup= mysql_query($sql_atualiza_dados_sup) or die (mysql_error());
}



//verifica e atualiza usuario supervisor
if($_POST['perfil'] == 3){

            if($id_perfil != 3){

                 $sql_insere_supervisor = ("INSERT INTO Supervisor(nome, cpf)
                                            VALUES('{$_POST['nome']}', '{$_POST['cpf']}')");

            }else{
             
                  $sql_insere_supervisor = "UPDATE Supervisor
                                            SET 
                                                nome = '{$_POST['nome']}' 
                                                cpf  = '{$_POST['cpf']}'
                                            WHERE cpf = '{$cpf_supervisor}'";
            }
        

        $acao_insere= mysql_query($sql_insere_supervisor) or die (mysql_error());                            
}

      $sql_insere="UPDATE usuario
                  SET 
                    nome      = '{$_POST['nome']}'
                    ,cpf       = '{$_POST['cpf']}'
                    ,id_perfil = '{$_POST['perfil']}'
                    ,id_turno  = '{$_POST['turno']}'
                    ,id_supervisor  = '{$_POST['supervisor']}'
                  WHERE id_usuario = $id_usuario";

                      
     $acao_insere= mysql_query($sql_insere) or die (mysql_error());

echo" <script> 
        alert('Cadastro atualizado com sucesso!');
        document.location.replace('../fixa/principal.php?t=forms/home.php');
      </script>
      ";                                        
    exit();
    
?>