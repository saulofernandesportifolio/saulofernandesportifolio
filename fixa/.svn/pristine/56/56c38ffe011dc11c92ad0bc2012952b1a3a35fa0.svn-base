<?php
// Verifica se foi feita alguma busca
// Caso contrario, redireciona o visitante pra home

include("../fixa/bd.php");

 // Salva o que foi buscado em uma variável
$pedido = $_GET['pedido'];

?>

<div id="t_consulta_solicitacao" style="margin-left: 24%; ">
		<table class="tabelas_dashboard">
		<caption>
			<h2>Histórico</h2>
		</caption>
			<thead>
                <tr>
                    <th>Data</th>
                    <th>Operador</th>
                    <th>Siscom</th>
                    <th>Nº GS</th>
                    <th>Fase</th>
                    <th>Revisão</th>
                </tr>
            </thead>
            <tbody>
           	 <?php 
     
			     
			       
			     	$buscarHistorico=mysql_query("SELECT DISTINCT
														U.nome AS operador,
														PTH.siscom,
														PTH.n_gestao_servicos,
														DATE_FORMAT( PTH.reg_dt_entrada , '%d/%c/%Y %H:%i:%s' ) as data,
														'Pre-Tramitacão' AS fase
													FROM pre_tramitacao_historico PTH
														LEFT JOIN usuario U
															ON PTH.id_usuario_pre = U.id_usuario
																WHERE pth.siscom =  $pedido
													UNION
													SELECT DISTINCT
														U.nome AS operador,
														th.siscom,
														th.n_gestao_servicos,
														DATE_FORMAT( th.reg_dt_entrada , '%d/%c/%Y %H:%i:%s' ) as data,
														'Tramitação' AS fase
													FROM tramitacao_historico th
														LEFT JOIN usuario U
															ON th.id_usuario_tramitacao = U.id_usuario
																WHERE th.siscom = $pedido
													UNION
													SELECT DISTINCT
														U.nome AS operador,
														th.siscom,
														th.n_gestao_servicos,
														DATE_FORMAT( th.reg_dt_entrada , '%d/%c/%Y %H:%i:%s' ) as data,
														'Pós-Tramitação' AS fase
													FROM pos_tramitacao_historico th
														LEFT JOIN usuario U
															ON th.id_usuario_pos_tramitacao = U.id_usuario
																WHERE th.siscom = $pedido
													UNION
													SELECT DISTINCT
														U.nome AS operador,
														'' AS siscom,
														ih.n_gestao_servicos,
														DATE_FORMAT( ih.reg_dt_entrada , '%d/%c/%Y %H:%i:%s' ) as data,
														'Intragov' AS fase
													FROM intragov_historico ih
														LEFT JOIN usuario U
															ON ih.id_usuario_intragov = U.id_usuario
															WHERE ih.n_gestao_servicos = $pedido
													UNION
													SELECT DISTINCT
														U.nome AS operador,
														'' AS siscom,
														g.n_gestao_servicos,
														DATE_FORMAT( g.reg_dt_entrada , '%d/%c/%Y %H:%i:%s' ) as data,
														'Gcom' AS fase
													FROM gcom_historico g
														LEFT JOIN usuario U
															ON g.id_usuario_gcom = U.id_usuario
															WHERE g.n_gestao_servicos = $pedido
												");
			     	$revisao = 1;

			     	if(mysql_affected_rows() > 0){
				     	while($linhash=mysql_fetch_array($buscarHistorico)){ 

				        	if($linhash['fase'] == 'Pre-Tramitacão'){
				        		$form = 'pt';
				        		$id_pedido = $linhash['siscom'];
				        	}else if($linhash['fase'] == 'Tramitação'){
				        		$form = 't';
				        		$id_pedido = $linhash['siscom'];
				        	}else if($linhash['fase'] == 'Intragov'){
				        		$form = 'i';
				        		$id_pedido = $linhash['n_gestao_servicos'];
				        	}else if($linhash['fase'] == 'Gcom'){
				        		$form = 'g';
				        		$id_pedido = $linhash['n_gestao_servicos'];
				        	}
				        ?>          
				         <tr>
				         	<td class="colunas-centralizados">
				              <a id="td">
				                <?php echo $linhash['data'];  ?>
				              </a>
				            </td>
				            <td class="colunas-centralizados">
				              <a id="td">
				                <?php echo $linhash['operador']; ?>
				              </a>
				            </td>
				            <td class="colunas-centralizados">
				              <a id="td">
				                <?php echo $linhash['siscom']; ?>
				              </a>
				            </td>
				            <td class="colunas-centralizados">
				              <a id="td">
				                <?php echo $linhash['n_gestao_servicos']; ?>
				              </a>
				            </td>
				              <td class="colunas-centralizados">
				              <a id="td">
				                <?php echo $linhash['fase']; ?>
				              </a>
				            </td>
				              <td class="colunas-centralizados">
				              <a id="td" href="principal.php?&id=<?php echo $cripto->codificar($id_pedido)?>&form=<?php echo $form?>&t=views/v_form_dados.php">
				                <?php echo $revisao++ ?>
				              </a>
				            </td>
				          </tr>
			     <?php 
		     			}
	     			}
		          ?>
           </tbody>
		</table>
		<br/>
		<br/>
			<input name="cancelar" type="button" value="Voltar" class="sb2 bradius" onClick="document.location.href='principal.php?id=<?php echo $cripto->codificar($id_usuario)?>&t=views/v_consulta.php'"/>

	</div>