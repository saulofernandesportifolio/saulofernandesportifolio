<?php
include("../fixa/bd.php");
include("../fixa/site/funcoes/f_geral.php");
require_once '../fixa/site/classes/cripto.php';
require_once '../fixa/site/classes/SolicitacaoTramitacao.php';

$tempo = 0;
set_time_limit($tempo);
date_default_timezone_set("Brazil/East");
$data_cadastro=date("Y-m-d H:i:s");
?>

<?php
    $id_usuario     =  $_POST['id_usuario'];
    $id_solicitacao =  $_POST['id_solicitacao'];
    $id_usuario     =  $cripto->decodificar($id_usuario);   
    $revisao        =  $_POST['revisao'];

?>

<?php
    $cripto = new cripto();
    $SolicitacaoTramitacao = new SolicitacaoTramitacao();

    //constroi solicitacao
    $SolicitacaoTramitacao->constroiSolicitacaoTramitacao($SolicitacaoTramitacao, $id_usuario, $id_solicitacao, $_POST['devolucao'], $_POST['status_solicitacao'], $_POST['aprovacao'], $_POST['data_encerramento'], $_POST['n_oport_proposta'], $_POST['obs'], $data_cadastro);

    //valida campos obrigatórios
    if($SolicitacaoTramitacao->validaCamposObrigatorios($SolicitacaoTramitacao) == 1)
    {
            echo" <script> 
                    alert('Por favor preencher todos os campos obrigatórios !');
                    history.back();
                  </script>
                  "; 
                  exit();   
    }
   
   
    //valida campos obrigatorios iniciados - devolucao
         if (isset($_POST['motivo_devolucao']) && isset($_POST['descricao_motivo_devolucao']) && isset($_POST['area_devolucao']) &&isset($_POST['data_devolucao']))
         {
              //caso haja algum em branco informa ao usuario se nao tiver manda dados ao objeto
              if($SolicitacaoTramitacao->validaItensDevolucao($_POST['motivo_devolucao'], $_POST['descricao_motivo_devolucao'], $_POST['area_devolucao'], $_POST['data_devolucao']) == 1)
              {
                 echo" <script> 
                  alert('Todos os campos de devolução devem ser preenchidos!');
                  history.back();
                </script>"; 
                exit();  
              }
              else
              {
                  $SolicitacaoTramitacao->motivo_devolucao           = $_POST['motivo_devolucao'];
                  $SolicitacaoTramitacao->descricao_motivo_devolucao = $_POST['descricao_motivo_devolucao'];
                  $SolicitacaoTramitacao->area_devolucao             = $_POST['area_devolucao'];
                  $SolicitacaoTramitacao->data_devolucao             = $_POST['data_devolucao'];
                  if(isset($_POST['chamado_remedy']))
                  {
                    $SolicitacaoTramitacao->chamado_remedy           = $_POST['chamado_remedy'];
                  }
                  else
                  {
                      $SolicitacaoTramitacao->chamado_remedy         = '';
                  }
              }  
         }

    //busca revisao
    $SolicitacaoTramitacao->revisao = $revisao;
    
    //busca informacoes ja inseridas na fase de pretramitacao
    $SolicitacaoTramitacao = $SolicitacaoTramitacao->buscaObjetoByIdsolicitacao($SolicitacaoTramitacao, $SolicitacaoTramitacao->id_solicitacao, $revisao);

    //insere dados em variavel para proc
    $dadosProc = '&'. $SolicitacaoTramitacao->id_usuario_tramitacao
               . '&'. $SolicitacaoTramitacao->id_solicitacao 
               . '&'. $SolicitacaoTramitacao->data_encerramento
               . '&'. $SolicitacaoTramitacao->id_status_solic_tramitacao
               . '&'. $SolicitacaoTramitacao->data_devolucao
               . '&'. $SolicitacaoTramitacao->devolucao
               . '&'. $SolicitacaoTramitacao->aprovado
               . '&'. $SolicitacaoTramitacao->reg_dt_entrada
               . '&'. $SolicitacaoTramitacao->n_oportunidade_propostas
               . '&'. $SolicitacaoTramitacao->obs
               . '&'. $SolicitacaoTramitacao->cat_produto              
               . '&'. $SolicitacaoTramitacao->id_canal_entrada         
               . '&'. $SolicitacaoTramitacao->id_produto               
               . '&'. $SolicitacaoTramitacao->tipo_solicitacao
               . '&'. $SolicitacaoTramitacao->complemento_tipo_solicitacao              
               . '&'. $SolicitacaoTramitacao->cnpj                     
               . '&'. $SolicitacaoTramitacao->razao_social             
               . '&'. $SolicitacaoTramitacao->qtd_acessos              
               . '&'. $SolicitacaoTramitacao->n_gestao_servicos        
               . '&'. $SolicitacaoTramitacao->data_abertura_gestao     
               . '&'. $SolicitacaoTramitacao->data_entrada_id_solicitacao
               . '&'. $SolicitacaoTramitacao->chamado_remedy
               . '&'. $SolicitacaoTramitacao->revisao;     

   
    $sql_exec="CALL solicitacao_tramitacao('$dadosProc');";

    $acao_exec= mysql_query($sql_exec) or die (mysql_error());

   
      echo" <script> 
        alert('Solicitação cadastrada com sucesso!');
           document.location.href='principal.php?id=" . $cripto->codificar($id_usuario) . "&t=views/home.php'
        </script>
        ";                                       
    exit();
   
?>